<div class="page" (click)="closeMessageMenu(); closeInclusionMenu()">
  <header class="topbar">
    <div>
      <h1>LLM Workspace</h1>
    </div>
    <button class="secondary" (click)="openSettings()">LLM Settings</button>
  </header>

  <main class="layout">
    <aside class="sidebar panel">
      <section>
        <div class="row-head">
          <h2>Folders</h2>
        </div>
        <div class="folder-create">
          <input type="text" [(ngModel)]="newFolderName" placeholder="New folder name" />
          <button class="secondary" (click)="createFolder()">Add</button>
        </div>
        <div class="folder-list">
          <div
            class="folder-item"
            *ngFor="let folder of folders; trackBy: trackById"
            [class.active]="folder.id === selectedFolderId"
            [class.drop-target]="dropFolderId === folder.id"
            (click)="selectFolder(folder.id)"
            (dragover)="onFolderDragOver(folder.id, $event)"
            (drop)="onChatDropOnFolder(folder.id, $event)"
            (dragleave)="dropFolderId = ''"
          >
            <span>{{ folder.name }}</span>
            <span class="folder-actions">
              <span class="folder-temp" *ngIf="folder.temperature != null">T={{ folder.temperature }}</span>
              <button type="button" class="folder-settings-btn" (click)="openFolderSettings(folder, $event)" aria-label="Folder settings">⚙</button>
            </span>
          </div>
        </div>
      </section>

      <section *ngIf="selectedFolderId">
        <div class="row-head">
          <h2>Chats</h2>
          <button class="secondary" (click)="createChat()">New Chat</button>
        </div>
        <div class="chat-list">
          <div
            class="chat-item"
            *ngFor="let chat of chats; trackBy: trackById"
            [class.active]="chat.id === selectedChatId"
            draggable="true"
            (click)="selectChat(chat.id)"
            (dragstart)="startChatDrag(chat.id)"
            (dragend)="endChatDrag()"
          >
            <ng-container *ngIf="editingChatId !== chat.id; else editingTitle">
              <span>{{ chat.title }}</span>
              <button type="button" class="chat-rename-btn" (click)="startRenameChat(chat, $event)" aria-label="Rename chat">✎</button>
            </ng-container>
            <ng-template #editingTitle>
              <input
                #chatRenameInput
                type="text"
                [(ngModel)]="editingChatTitle"
                (click)="$event.stopPropagation()"
                (keydown.enter)="saveRenameChat(chat.id)"
                (keydown.escape)="cancelRenameChat()"
                (blur)="saveRenameChat(chat.id)"
              />
            </ng-template>
          </div>
        </div>
      </section>
    </aside>

    <section class="main panel">
      <app-quick-selector [targets]="quickTargets" [selectedTargetIds]="selectedTargets" (toggle)="toggleTarget($event)"></app-quick-selector>

      <section class="history" *ngIf="selectedChat; else noChat">
        <div class="message-group" *ngFor="let group of messageGroups; trackBy: trackByGroup">
          <app-message-card
            [message]="group.user"
            roleLabel="user"
            [showProvider]="false"
            [showSummaryBadge]="false"
            [showEditAction]="true"
            [canMoveHistory]="canMoveMessageHistory(group.user)"
            [historyPosition]="messageHistoryPosition(group.user)"
            [historyAtStart]="(group.user.historyIndex ?? ((group.user.history?.length ?? 1) - 1)) <= 0"
            [historyAtEnd]="(group.user.historyIndex ?? ((group.user.history?.length ?? 1) - 1)) >= ((group.user.history?.length ?? 1) - 1)"
            [inclusionMenuOpen]="openInclusionMessageId === group.user.id"
            [messageMenuOpen]="openMessageMenuId === group.user.id"
            [inclusionValue]="messageInclusionValue(group.user)"
            [inclusionDisplayLabel]="inclusionDisplayLabel(group.user)"
            [inclusionOptions]="messageInclusionOptions(group.user)"
            [inclusionOptionTitle]="inclusionOptionTitle"
            (moveHistory)="moveMessageHistory(group.user, $event)"
            (toggleInclusion)="toggleInclusionMenu(group.user.id, $event)"
            (selectInclusion)="onMessageInclusionChange(group.user, $event); closeInclusionMenu()"
            (toggleMenu)="toggleMessageMenu(group.user.id, $event)"
            (regenerate)="regenerateFromMessage(group.user)"
            (fork)="forkFromMessage(group.user)"
            (edit)="openEditUserMessage(group.user)"
          ></app-message-card>

          <div class="assistant-stack">
            <app-message-card
              *ngFor="let msg of group.assistants; trackBy: trackById"
              [message]="msg"
              roleLabel="assistant"
              [showProvider]="true"
              [showSummaryBadge]="true"
              [showEditAction]="false"
              [canMoveHistory]="canMoveMessageHistory(msg)"
              [historyPosition]="messageHistoryPosition(msg)"
              [historyAtStart]="(msg.historyIndex ?? ((msg.history?.length ?? 1) - 1)) <= 0"
              [historyAtEnd]="(msg.historyIndex ?? ((msg.history?.length ?? 1) - 1)) >= ((msg.history?.length ?? 1) - 1)"
              [inclusionMenuOpen]="openInclusionMessageId === msg.id"
              [messageMenuOpen]="openMessageMenuId === msg.id"
              [inclusionValue]="messageInclusionValue(msg)"
              [inclusionDisplayLabel]="inclusionDisplayLabel(msg)"
              [inclusionOptions]="messageInclusionOptions(msg)"
              [inclusionOptionTitle]="inclusionOptionTitle"
              (moveHistory)="moveMessageHistory(msg, $event)"
              (toggleInclusion)="toggleInclusionMenu(msg.id, $event)"
              (selectInclusion)="onMessageInclusionChange(msg, $event); closeInclusionMenu()"
              (toggleMenu)="toggleMessageMenu(msg.id, $event)"
              (regenerate)="regenerateFromMessage(msg)"
              (fork)="forkFromMessage(msg)"
            ></app-message-card>
          </div>

          <div class="group-summary">
            <select [ngModel]="summaryTargetId(group.user.id)" (ngModelChange)="setSummaryTargetId(group.user.id, $event)">
              <option *ngFor="let model of summaryModelOptions; trackBy: trackById" [value]="model.id">
                {{ providerIcon(model.provider) }} · {{ model.model }}
              </option>
            </select>
            <button
              type="button"
              class="secondary"
              (click)="requestSummarize(group.user.id)"
              [disabled]="!summaryTargetId(group.user.id)"
            >
              {{ isSummaryPending(group.user.id) ? 'Queued...' : 'Summarize' }}
            </button>
            <span class="muted" *ngIf="isSummaryPending(group.user.id)">Will run when current generation finishes.</span>
          </div>
        </div>
      </section>
      <ng-template #noChat>
        <p class="muted">Create or select a chat to start.</p>
      </ng-template>

      <app-chat-composer
        [prompt]="prompt"
        [isStreaming]="isStreaming"
        [error]="error"
        [attachments]="pendingTextFiles"
        [selectedTargetsSize]="selectedTargets.size"
        [isContextLoading]="isContextLoading"
        [minContextItem]="minContextItem"
        [contextItems]="contextIndicatorItems"
        [contextLoadError]="contextLoadError"
        (promptChange)="prompt = $event"
        (promptChanged)="onPromptChanged()"
        (filesSelected)="onFilesSelected($event)"
        (removeAttachment)="removeAttachment($event)"
        (submit)="submit()"
        (cancel)="cancel()"
      ></app-chat-composer>
    </section>
  </main>
</div>

<app-llm-settings-modal
  [show]="showSettings"
  [config]="config"
  [openRouterModelsInput]="modelsToInput(config.openrouter.models)"
  [ollamaModelsInput]="modelsToInput(config.ollama.models)"
  (close)="closeSettings()"
  (save)="saveSettings()"
  (openRouterModelsInputChange)="updateOpenRouterModels($event)"
  (ollamaModelsInputChange)="updateOllamaModels($event)"
></app-llm-settings-modal>

<app-edit-user-message-modal
  [show]="showEditMessageModal"
  [content]="editingUserMessageContent"
  [attachments]="editingUserAttachments"
  [mode]="editingUserMessageMode"
  (close)="closeEditUserMessageModal()"
  (apply)="saveEditUserMessage()"
  (contentChange)="editingUserMessageContent = $event"
  (filesSelected)="onEditModalFilesSelected($event)"
  (removeAttachment)="removeEditAttachment($event)"
  (modeChange)="editingUserMessageMode = $event"
></app-edit-user-message-modal>

<app-folder-settings-modal
  [show]="showFolderSettings"
  [name]="folderSettingsName"
  [prompt]="folderSettingsPrompt"
  [temperature]="folderSettingsTemperature"
  (close)="closeFolderSettings()"
  (save)="saveFolderSettings()"
  (nameChange)="folderSettingsName = $event"
  (promptChange)="folderSettingsPrompt = $event"
  (temperatureChange)="folderSettingsTemperature = $event"
></app-folder-settings-modal>
